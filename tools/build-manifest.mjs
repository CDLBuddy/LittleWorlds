#!/usr/bin/env node

/**
 * Build manifest generator
 * Scans public/assets/ and generates src/game/assets/manifest.ts
 */

import { writeFile } from 'fs/promises';
import { join } from 'path';
import { globby } from 'globby';
import { fileURLToPath } from 'node:url';
import { dirname } from 'node:path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');

const ASSETS_DIR = join(rootDir, 'public/assets');
const OUTPUT_FILE = join(rootDir, 'src/game/assets/manifest.ts');

async function generateManifest() {
  console.log('Generating asset manifest...');

  try {
    // Use globby for modern, promise-based file scanning
    const allFiles = await globby('**/*', {
      cwd: ASSETS_DIR,
      onlyFiles: true,
      gitignore: true,
    });
    
    const manifest = {
      models: [],
      textures: [],
      audio: [],
      ui: [],
      data: [],
    };

    allFiles.forEach((file) => {
      const relativePath = `assets/${file.replace(/\\/g, '/')}`;
      
      if (relativePath.includes('/models/')) manifest.models.push(relativePath);
      else if (relativePath.includes('/textures/')) manifest.textures.push(relativePath);
      else if (relativePath.includes('/audio/')) manifest.audio.push(relativePath);
      else if (relativePath.includes('/ui/')) manifest.ui.push(relativePath);
      else if (relativePath.includes('/data/')) manifest.data.push(relativePath);
    });

    const output = `/**
 * Asset manifest - AUTO-GENERATED by build-manifest.mjs
 * DO NOT EDIT MANUALLY
 */

export interface AssetManifest {
  models: string[];
  textures: string[];
  audio: string[];
  ui: string[];
  data: string[];
}

export const assetManifest: AssetManifest = ${JSON.stringify(manifest, null, 2)};

// Keyed audio paths for easy loading
export const AUDIO: Record<string, string> = {
${manifest.audio.map(path => {
  const filename = path.split('/').pop() || '';
  const key = filename.replace(/\.(ogg|mp3|wav)$/, '');
  return `  '${key}': '${path}'`;
}).join(',\n')}
};
`;

    await writeFile(OUTPUT_FILE, output);
    console.log(`âœ“ Manifest generated: ${OUTPUT_FILE}`);
    console.log(`  Models: ${manifest.models.length}`);
    console.log(`  Textures: ${manifest.textures.length}`);
    console.log(`  Audio: ${manifest.audio.length}`);
    console.log(`  UI: ${manifest.ui.length}`);
    console.log(`  Data: ${manifest.data.length}`);
  } catch (error) {
    console.error('Failed to generate manifest:', error);
    process.exit(1);
  }
}

generateManifest();
